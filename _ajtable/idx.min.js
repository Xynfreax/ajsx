$$.require(["../globalFunciones","../../vista/gfunctions","str","../ajinputlabel/ajinputlabel"],function(){Object.assign($.ajtable,{orderby:{},options:{maxpagesshown:5,rowsxpageList:[{0:false},{5:false},{10:true},{50:false}],showRowsxpage:true,selectMode:"simple"},model:[{cod:"1",val:"nombre"},{cod:"1",val:"nombre"},{cod:"1",val:"nombre"},{cod:"1",val:"nombre"},{cod:"1",val:"nombre"}],mask:[{field:"id",header:"id",filterable:true,hidden:false,type:"number"},{field:"apellidos",header:"Apellidos asdfas dfas gsg dafggfa ga g",
val:{obj:{tag:"b"},fields:{textContent:"own"}},filterable:true,orderby:"desc"}],customProps:{showPagination:{set:function(v){if(v==false){this.options.rowsxpageList=[{0:true}];this.mytop.myrowsxpage.display="none";this.box.mynav.display="none"}},configurable:true},showSearch:{set:function(v){if(v==false)this.mytop.myfilterfields.display="none"},configurable:true},showTop:{set:function(v){if(v==false){this.showPagination=false;this.showSearch=false}},configurable:true}},afterReload:function(){function $jscomp$async$generator(){var $jscomp$generator$state=
0;function $jscomp$generator$impl($jscomp$generator$next$arg,$jscomp$generator$throw$arg){while(1)switch($jscomp$generator$state){case 0:$jscomp$generator$state=-1;default:return{value:undefined,done:true}}}var iterator=({next:function(arg){return $jscomp$generator$impl(arg,undefined)},throw:function(arg){return $jscomp$generator$impl(undefined,arg)},return:function(arg){throw Error("Not yet implemented");}});$jscomp.initSymbolIterator();iterator[Symbol.iterator]=function(){return this};return iterator}
return $jscomp.executeAsyncGenerator($jscomp$async$generator())},afterSelectRow:function(rsel){},setSelectedRow:function(ind,resel){var th=this;var rows=th.box.middle.tablebody.mytbody.children;if(get_type(ind)==3)ind=[ind];var rt=null;for(var i=0;i<rows.length;i++){var actRowAo=rows[i];if(th.options.selectMode!=="multiple"){actRowAo.classList.remove("selected");actRowAo.selected=false}if(ind.indexOf(actRowAo.ind)>-1){actRowAo.classList.add("selected");actRowAo.selected=true;rt=actRowAo;if(resel!==
false);}}if(rt&&rt.dom.offsetTop+rt.dom.offsetHeight-30>th.box.middle.dom.scrollTop+th.box.middle.dom.offsetHeight)rt.dom.scrollIntoView(false);var overf=th.box.middle.getCS("overflow-y");if(rt&&rt.dom.offsetTop<th.box.middle.dom.scrollTop+30&&(overf=="auto"||overf=="scroll"))th.box.middle.dom.scrollTo(0,rt.dom.offsetTop-30);else;th.afterSelectRow();return rt},getSelectedRow:function(inmodel){var th=this;var rows=th.box.middle.tablebody.mytbody.children;var rt=[];for(var i=0;i<rows.length;i++){var actRowAo=
rows[i];if(actRowAo.selected==true)if(inmodel==true)rt.push(th.model[i]);else if(inmodel==2)rt.push(i);else rt.push(actRowAo)}if(rt.length==1)return rt[0];else if(rt.length>1)return rt;else return undefined},generateCell:function(mask,field,row){var rt={tag:"td",tabIndex:0};rt.field=mask.field;if(mask.val==undefined)rt.textContent=row[field];else if(get_type(mask.val)==2)if(row[field]==undefined||row[field]==null)rt.textContent=mask.val;else rt.textContent=row[field];else if(get_type(mask.val)==0&&
get_type(mask.val.obj)==0&&mask.val.obj.tag!==undefined){var cellAo=mask.val.obj;var fields=[];if(get_type(mask.val.fields)==0)fields=mask.val.fields;var count=0;var tama=Object.keys(fields).length;var fieldToUse=null;var fieldToUse2=null;for(var k in fields){var actFieldReferred=fields[k];var actFieldProp=k;cellAo[actFieldProp]=actFieldReferred=="own"?row[field]:row[actFieldReferred];count++;if(tama==count){fieldToUse2=actFieldProp;if(actFieldReferred=="own"){row[field]=cellAo[actFieldProp];fieldToUse=
field}else{fieldToUse=actFieldReferred;row[actFieldReferred]=cellAo[actFieldProp]}}}cellAo.load_r=function(){var th=this;Object.defineProperty(row,fieldToUse,{get:function(){return th[fieldToUse2]},set:function(v){th[fieldToUse2]=v},enumerable:true,configurable:true})};rt.children=[cellAo]}return rt},qmodel:"listaAlumnosInscritos",qparams:{filterFields:{}},aqmodel:function(query_,params_){var $jscomp$async$this=this;function $jscomp$async$generator(){var $jscomp$generator$state=0;var $jscomp$generator$next$arg2;
var resp;var query;var params;var th;function $jscomp$generator$impl($jscomp$generator$next$arg,$jscomp$generator$throw$arg){while(1)switch($jscomp$generator$state){case 0:th=$jscomp$async$this;params=params_;query=query_;if(query==undefined)query=th.qmodel;if(params==undefined)params=th.qparams?extenderObj(th.qparams):{};th.setOrderby();th.orderTable();params.orderby=th.orderby;Object.assign(params.filterFields,th.getFilterFields());params.limit=th.limit;params.offset=th.offset;console.log("params a senviar:",
params);resp={};if(!(query!==undefined)){$jscomp$generator$state=1;break}th.startwaiting();th.qmodel=query;$jscomp$generator$state=2;return{value:$_.query(query,params),done:false};case 2:if(!($jscomp$generator$throw$arg!==undefined)){$jscomp$generator$state=3;break}$jscomp$generator$state=-1;throw $jscomp$generator$throw$arg;case 3:$jscomp$generator$next$arg2=$jscomp$generator$next$arg;resp=$jscomp$generator$next$arg2;th.amodel(resp.data);th.stopwaiting();case 1:$jscomp$generator$state=-1;return{value:resp.data,
done:true};$jscomp$generator$state=-1;default:return{value:undefined,done:true}}}var iterator=({next:function(arg){return $jscomp$generator$impl(arg,undefined)},throw:function(arg){return $jscomp$generator$impl(undefined,arg)},return:function(arg){throw Error("Not yet implemented");}});$jscomp.initSymbolIterator();iterator[Symbol.iterator]=function(){return this};return iterator}return $jscomp.executeAsyncGenerator($jscomp$async$generator())},amodel:function(model_){var th=this;var model=model_;if(model==
undefined)model=this.model;if(model==undefined)model=[];th.box.middle.tablebody.mytbody.emptyChildren();var limitSup=model.length>th.offset+th.limit?th.offset+th.limit:model.length;if(model.length>0)totalrows=model[0].c;else totalrows=0;for(var i=0;i<model.length;i++){var actItemRow=model[i];var rowJson={tag:"ajrow",ind:i};var newRowAo=$f.instanciar(rowJson);th.box.middle.tablebody.mytbody.addChild_r(newRowAo);for(var ii=0;ii<th.mask.length;ii++){var actFieldMask=th.mask[ii];var actFieldVal=actItemRow[actFieldMask.field];
var newCellAo=$f.instanciar(th.generateCell(actFieldMask,actFieldMask.field,actItemRow));newRowAo.addChild_r(newCellAo);newCellAo.dom.dataset.field=actFieldMask.field;if(actFieldMask.hidden==true)newCellAo.dom.dataset.hidden=true;if(actFieldMask.type){newCellAo.dom.dataset.type=actFieldMask.type;if(actFieldMask.type=="money")if(actFieldVal)newCellAo.textContent=parseFloat(actFieldVal).toFixed(2)}if(get_type(actFieldMask.after)==4)actFieldMask.after(actFieldMask.field,actFieldVal,newCellAo,newRowAo)}}th.model=
model;if(model.length>0&&th.mode!=="popup")th.setPagination(totalrows);if(model.length>0&&th.mode=="popup"&&th.dom.contains(document.activeElement)){th.setPagination(totalrows);th.box.classList.add("open");th.box.classList.remove("closed")}else if(th.mode!=="popup"){th.box.classList.add("closed");th.box.classList.remove("open")}th.updateHeader();if(th.model.length>0)th.setSelectedRow(0,false);th.afterReload()},reloadModel:function(ind,isamodel){var $jscomp$async$this=this;function $jscomp$async$generator(){var $jscomp$generator$state=
0;var aqm$1;var $jscomp$generator$next$arg3;var aqm$0;var aqm;var lastselected;var th;function $jscomp$generator$impl($jscomp$generator$next$arg,$jscomp$generator$throw$arg){while(1)switch($jscomp$generator$state){case 0:th=$jscomp$async$this;lastselected=0;if(ind==true)lastselected=th.getSelectedRow(2)||0;else if(get_type(ind)==3)lastselected=ind;aqm=null;if(!(isamodel==true)){$jscomp$generator$state=1;break}aqm$0=th.amodel();$jscomp$generator$state=2;break;case 1:$jscomp$generator$state=3;return{value:th.aqmodel(),
done:false};case 3:if(!($jscomp$generator$throw$arg!==undefined)){$jscomp$generator$state=4;break}$jscomp$generator$state=-1;throw $jscomp$generator$throw$arg;case 4:$jscomp$generator$next$arg3=$jscomp$generator$next$arg;aqm$1=$jscomp$generator$next$arg3;case 2:th.setSelectedRow(lastselected);if(get_type(ind)==3){var lastrow=th.getSelectedRow();var lastrowtop=lastrow.dom.offsetTop;th.box.middle.dom.scrollTo(0,lastrowtop)}$jscomp$generator$state=-1;return{value:aqm,done:true};$jscomp$generator$state=
-1;default:return{value:undefined,done:true}}}var iterator=({next:function(arg){return $jscomp$generator$impl(arg,undefined)},throw:function(arg){return $jscomp$generator$impl(undefined,arg)},return:function(arg){throw Error("Not yet implemented");}});$jscomp.initSymbolIterator();iterator[Symbol.iterator]=function(){return this};return iterator}return $jscomp.executeAsyncGenerator($jscomp$async$generator())},getFilterFields:function(){var th=this;var rt={};console.log(th.mytop.myfilterfields.myselect.value);
var field_=th.mytop.myfilterfields.myselect.value;console.log("---obteniendo selectedrow de ajselect: ",th.mytop.myfilterfields.myselect.getSelectedRow());if(field_)rt[field_]={val:th.mytop.myfilterfields.myinput.value,type:th.mytop.myfilterfields.myselect.getSelectedRow().type};return rt},startwaiting:function(){this.classList.add("waiting")},stopwaiting:function(){this.classList.remove("waiting")},setOffset:function(offset_){var th=this;var offset=offset_;if(offset==undefined)offset=0;th.offset=
offset},setLimit:function(limit_){var th=this;var limit=limit_;if(limit==undefined)limit=th.mytop.myrowsxpage.value;th.limit=limit;th.setOffset()},setFilterFields:function(){var th=this;var model=[];if(th.mask){var selectedVal;for(var i=0;i<th.mask.length;i++){var actField=th.mask[i];if(actField.filterable!==undefined){console.log("--asignado filter fields: ",actField.type||"string");model.push({field:actField.field,val:actField.header,type:actField.type||"string"});if(actField.filterable==true)selectedVal=
actField.field}}th.mytop.myfilterfields.myselect.amodel(model);th.mytop.myfilterfields.myselect.value=selectedVal}},setOrderby:function(field_,direction_){var th=this;var field=field_;var direction=direction_;if(field==undefined){field=th.orderby.field;direction=th.orderby.direction}if(field==undefined||direction==undefined){if(th.mask)for(var i=0;i<th.mask.length;i++){var actField=th.mask[i];if(actField.orderby){th.orderby.field=actField.field;th.orderby.direction=actField.orderby}}if(!th.orderby.field){th.orderby.field=
th.mask[0].field;th.orderby.direction="asc"}}else{th.orderby.field=field;th.orderby.direction=direction}},setPagination:function(total_){var th=this;var total=total_;var limitsup=th.limit;if(limitsup==0)limitsup=total_;var totalPages=Math.ceil(total/limitsup);var actPage=Math.ceil((th.offset+1)/limitsup);th.box.mynav.mypagebuttons.emptyChildren();th.box.mynav.mydirbuttons.emptyChildren();for(var i=0;i<totalPages;i++){var isselectedclass="";if(i+1==actPage){isselectedclass=" actpage";if(i==0)th.box.mynav.mydirbuttons.addChild_r($f.instanciar({tag:"ajbutton",
classN:"mybutton",page:totalPages,text:"Ultimo"}));else if(i==totalPages-1)th.box.mynav.mydirbuttons.addChild_r($f.instanciar({tag:"ajbutton",classN:"mybutton",page:1,text:"Primero"}));else{th.box.mynav.mydirbuttons.addChild_r($f.instanciar({tag:"ajbutton",classN:"mybutton",page:1,text:"Primero"}));th.box.mynav.mydirbuttons.addChild_r($f.instanciar({tag:"ajbutton",classN:"mybutton",page:totalPages,text:"Ultimo"}))}}var actPageBtnAo=$f.instanciar({tag:"ajbutton",classN:"mybutton"+isselectedclass,text:i+
1,page:i+1});var showback=actPage-3;var shownext=actPage+1;if(i<showback||i>shownext)actPageBtnAo.display="none";th.box.mynav.mypagebuttons.addChild_r(actPageBtnAo)}},arowsxpage:function(model_){var th=this;var model=model_;if(model==undefined)model=th.options.rowsxpageList;var selectModel=[];var selectedVal=null;for(var i=0;i<model.length;i++){var actItem=model[i];var okeys=Object.keys(actItem);console.log(actItem[okeys[0]]);selectModel.push({cod:+okeys[0],val:okeys[0]});if(actItem[okeys[0]]==true)selectedVal=
okeys[0]}th.mytop.myrowsxpage.amodel(selectModel);if(selectedVal!==null)th.mytop.myrowsxpage.value=selectedVal},init:function(){var th=this;setTimeout(function(){var parent2=th.getParentBy("wmark","tabcontent");var als=new ResizeSensor(th.box.middle.dom,function(){th.updateHeader()})},0);th.mytop.events=[["focus",function(){if(th.mode=="popup")th.reloadModel()},true],["blur",function(){},true]];th.events=[["blur",function(){if(th.mode=="popup")setTimeout(function(){if(th.dom.contains(document.activeElement)==
false){th.box.classList.add("closed");th.box.classList.remove("open")}},50)},true]];th.box.tableheader.events=[["click",function(e){if(e.target.tagName=="DIV"){if(!th.orderdisabled){var actTh=$[e.target.id];th.orderTable(actTh);th.aqmodel()}}else;},false]];th.mytop.myrowsxpage.events=[["change",function(e){th.setLimit(this.value);th.aqmodel()}]];th.box.mynav.mypagebuttons.events=[["click",function(e){var mybutton=$[e.target.id].getParentBy("real_tag","button")||(e.target.tagName=="BUTTON"?$[e.target.id]:
null);if(mybutton){var actBtn=mybutton;th.setOffset((actBtn.page-1)*th.limit);actBtn.classList.add("preactpage");th.aqmodel().then(function(resolve){})}else;},false]];th.box.mynav.mydirbuttons.events=[["click",function(e){var mybutton=$[e.target.id].getParentBy("real_tag","button")||(e.target.tagName=="BUTTON"?$[e.target.id]:null);if(mybutton){var actBtn=mybutton;th.setOffset((actBtn.page-1)*th.limit);actBtn.classList.add("preactpage");th.aqmodel().then(function(resolve){})}else;},false]];th.mytop.myfilterfields.myselect.events=
[["change",function(e){th.aqmodel()}]];th.mytop.myfilterfields.myinput.events=[["input",function(e){clearTimeout(th.typingTimer);th.typingTimer=setTimeout(th.doneTyping.bind(th),th.doneTypingInterval)}],["keyup",function(e){if(e.keyCode==40){console.log("DOWN");var sele=th.getSelectedRow();console.log(sele.dom);if(sele!==undefined){console.log(sele.children[0].dom);var i=0;var first=sele.children[i];while(first.getCS("display")=="none"){i++;first=sele.children[i]}first.dom.focus()}}}]];th.box.middle.tablebody.mytbody.events=
[["focus",function(e){var mybutton=$[e.target.id].getParentBy("real_tag","td")||(e.target.tagName=="TD"?$[e.target.id]:null);if(mybutton){var actBtn=mybutton;var actTd=actBtn;th.setSelectedRow(actTd.parent.ind,true)}else;},true]];th.box.middle.events=[["keydown",function(e){if([38,40].indexOf(e.keyCode)>-1){var sele=th.getSelectedRow(2);var sele2;if(e.keyCode==40&&sele!==undefined&&th.model[sele+1]!==undefined){sele2=th.setSelectedRow(sele+1);e.preventDefault()}else if(e.keyCode==38&&sele!==undefined&&
th.model[sele-1]!==undefined){sele2=th.setSelectedRow(sele-1);e.preventDefault()}if(e.keyCode==38&&sele-1<0)th.mytop.myfilterfields.myinput.dom.focus()}if([36].indexOf(e.keyCode)>-1&&th.model[0]!==undefined)th.setSelectedRow(0);if([35].indexOf(e.keyCode)>-1&&th.model[th.model.length-1]!==undefined)th.setSelectedRow(th.model.length-1)},true]];th.box.middle.events=[["scroll",function(e){th.box.tableheader.left=-1*th.box.middle.dom.scrollLeft+"px"}]]},typingTimer:null,doneTypingInterval:250,doneTyping:function(){var th=
this;console.log("termine tipear");th.setOffset();th.aqmodel()},reloadinput:function(actAo_){var th=this;var actAo=actAo_;if(actAo==undefined)actAo=th.mytop.myfilterfields.myselect;var myinput=th.mytop.myfilterfields.myinput;var type=actAo.getSelectedRow().type;if(type=="number")myinput.type="number";if(type=="string")myinput.type="text";if(type=="date")myinput.type="date"},orderTable:function(fieldObj_){var th=this;var fieldObj=fieldObj_;if(fieldObj==undefined){var trHeader=th.box.tableheader.children[0];
for(var i=0;i<trHeader.children.length;i++){var actTh=trHeader.children[i];if(actTh.order=="asc"||actTh.order=="desc"){fieldObj=actTh;fieldObj.order=fieldObj.order=="asc"?"desc":"asc"}}}if(fieldObj==undefined)fieldObj=th.box.tableheader.children[0].children[0];function cleanTds(){var allTds=fieldObj.parent.dom.querySelectorAll("div");allTds.forEach(function(elementt,index,array){elementt.classList.remove("sorting_desc");elementt.classList.remove("sorting_asc");if($[elementt.id])$[elementt.id].order=
undefined})}var direction="desc";if(fieldObj.order=="asc"){cleanTds();fieldObj.order="desc";fieldObj.classList.add("sorting_desc")}else{cleanTds();fieldObj.order="asc";fieldObj.classList.add("sorting_asc");direction="asc"}th.orderby.field=fieldObj.field;th.setOrderby(fieldObj.field,direction)},setHeaders:function(){var th=this;var rowHeaderAo=th.box.tableheader.mydiv;var rowHeaderAo2=th.box.middle.tablebody.mytheader.mytr;rowHeaderAo.emptyChildren();rowHeaderAo2.emptyChildren();for(var i=0;i<th.mask.length;i++){var actFieldHeader=
th.mask[i];var newJson={tag:"div",textContent:actFieldHeader.header,field:actFieldHeader.field,order:actFieldHeader.orderby,load_r:function(){this.dom.unselectable="on";var elm=this.dom;var thh=this;var realth=thh.parent.parent.parent.children[1].children[0].children[0].children[0].children[0];var startX=0;var startWidth=elm.offsetWidth;var resizer=document.createElement("div");resizer.style.width="4px";resizer.style.height="100%";resizer.style.background="transparent";resizer.style.position="absolute";
resizer.style.right=0;resizer.style.borderRight="solid 1px rgb(143, 143, 143)";resizer.style.bottom=0;resizer.style.cursor="e-resize";elm.appendChild(resizer);resizer.addEventListener("mousedown",initResize,false);function initResize(e){startX=e.clientX;startWidth=elm.offsetWidth;console.log(startX);console.log(startWidth);window.addEventListener("mousemove",Resize,false);window.addEventListener("mouseup",stopResize,false)}function Resize(e){console.log(startX);console.log(e.clientX);console.log(e.clientX-
startX);var newWidth=e.clientX-startX+startWidth+"px";var realth=thh.parent.parent.parent.children[1].children[0].children[0].children[0].children[thh.indice];elm.style.width=newWidth;elm.style.maxWidth=newWidth;elm.style.minWidth=newWidth;realth.width=newWidth;realth.maxWidth=newWidth;realth.minWidth=newWidth}function stopResize(e){var realth=thh.parent.parent.parent.children[1].children[0].children[0].children[0].children[thh.indice];if(elm.offsetWidth<realth.dom.offsetWidth){console.log("---\x3e>>>IF");
console.log(elm.offsetWidth);console.log(realth.dom.offsetWidth);elm.style.width=realth.dom.offsetWidth+"px";elm.style.minWidth=realth.dom.offsetWidth+"px";elm.style.maxWidth=realth.dom.offsetWidth+"px"}else{console.log("---\x3e>>>ELSE");console.log(elm.offsetWidth);console.log(realth.dom.offsetWidth)}window.removeEventListener("mousemove",Resize,false);window.removeEventListener("mouseup",stopResize,false);th.updateHeader()}}};var newJson2={tag:"th",textContent:actFieldHeader.header,field:actFieldHeader.field,
order:actFieldHeader.orderby};var newCell1=$f.instanciar(newJson);var newCell2=$f.instanciar(newJson2);if(actFieldHeader.hidden==true){newCell1.classN+=" hidden";newCell2.classN+=" hidden"}rowHeaderAo.addChild_r(newCell1);rowHeaderAo2.addChild_r(newCell2);newCell2.dom.dataset.field=actFieldHeader.field}},updateHeader:function(){var th=this;var middle=th.box.middle;var tableheader=th.box.tableheader.mydiv;var tablebody=middle.tablebody.mytbody;var tableheaderrow=tableheader;var firstRow=th.box.middle.tablebody.mytheader.children[0];
var tablebodyWidth=tablebody.dom.offsetWidth;if(firstRow){var firstRowWidth=firstRow.offsetWidth;if(firstRow!==undefined)for(var i=0;i<firstRow.children.length;i++){var actTd=firstRow.children[i];if(tableheaderrow.children[i]!==undefined){var actTh=tableheaderrow.children[i];var width_=actTd.dom.offsetWidth;actTh.width=width_+0+"px";actTh.minWidth=width_+0+"px";actTh.maxWidth=width_+0+"px"}}}else;},setpopup:function(){var th=this;if(th.mode=="popup"){th.classList.add("popup");th.box.classList.add("popup");
th.box.classList.add("closed")}},load_r:function(){var th=this;this.arowsxpage();th.setLimit();th.setHeaders();th.setFilterFields();th.setpopup();this.aqmodel()}})});
